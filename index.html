
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雲端資料中心部</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS for Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Markdown Parser (Simple) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- html2canvas for Charts -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        twm: {
                            orange: '#F37021', // TWM Orange
                            red: '#E30613',    // TWM Red
                            purple: '#84227C', // TWM Purple
                            blue: '#005CAF',   // TWM Blue
                            green: '#009944',  // TWM Green
                            dark: '#231815',
                            gray: '#E5E5E5'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        
        /* TWM Style Overrides */
        .sidebar-active { 
            background-color: #FFF0E5; 
            color: #F37021; 
            border-right: 3px solid #F37021;
        }
        .btn-primary {
            background-color: #F37021;
            color: white;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #D95E16;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(243, 112, 33, 0.3);
        }
        
        .kanban-col::-webkit-scrollbar { width: 6px; }
        .kanban-col::-webkit-scrollbar-thumb { background: #E5E7EB; border-radius: 3px; }

        /* Login Background */
        .login-bg {
            background: linear-gradient(135deg, #FFF0E5 0%, #FFFFFF 100%);
        }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden selection:bg-orange-100 bg-[#F8F9FA]">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-50 login-bg flex flex-col items-center justify-center hidden">
        <div class="bg-white p-10 rounded-2xl shadow-xl w-full max-w-md border border-slate-100">
            <div class="flex flex-col items-center mb-8">
                <!-- Logo: Generic Cloud Icon -->
                <div class="mb-6 p-4 bg-orange-50 rounded-full">
                    <i data-lucide="cloud" class="w-12 h-12 text-twm-orange"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-800">雲端資料中心部</h1>
                <p class="text-slate-500 text-sm mt-1">知識與專案管理系統</p>
                <div class="mt-2 px-3 py-1 bg-slate-100 rounded text-[10px] text-slate-500 font-bold border border-slate-200">
                    <i data-lucide="hard-drive" class="w-3 h-3 inline mr-1"></i> 本機離線模式 (C槽儲存)
                </div>
            </div>
            
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wide mb-1">帳號 Username</label>
                    <input type="text" id="login-username" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 text-slate-700 font-medium focus:ring-2 focus:ring-twm-orange outline-none" placeholder="輸入帳號">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wide mb-1">密碼 Password</label>
                    <input type="password" id="login-password" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 text-slate-700 font-medium focus:ring-2 focus:ring-twm-orange outline-none" placeholder="輸入密碼">
                </div>
                <div id="login-error" class="text-red-500 text-sm text-center hidden">帳號或密碼錯誤</div>
                <button type="submit" class="w-full btn-primary py-3 rounded-lg font-bold text-lg shadow-lg shadow-orange-200 mt-2">登入系統</button>
            </form>
        </div>
        <div class="mt-8 text-slate-400 text-xs text-center">
            <p>資料安全宣告：所有數據僅儲存於本機電腦硬碟 (C槽) 與 Excel 備份檔中。</p>
            <p>© 2025 CDC System. All rights reserved.</p>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="flex h-full hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-slate-200 flex flex-col transition-all duration-300 shadow-sm z-20" id="sidebar">
            <!-- Logo Area -->
            <div class="p-6">
                <div class="mb-4">
                    <i data-lucide="cloud" class="w-10 h-10 text-twm-orange"></i>
                </div>
                <div>
                    <div class="font-bold text-lg leading-tight tracking-tight text-slate-800">雲端資料中心部</div>
                    <div class="text-[10px] text-twm-orange font-bold tracking-widest uppercase">CDC System</div>
                </div>
            </div>
            
            <nav class="flex-1 overflow-y-auto px-4 space-y-2 mt-4">
                <div onclick="navigate('dashboard')" class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg cursor-pointer hover:bg-slate-50 text-slate-600 transition-colors">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span>儀表板</span>
                </div>
                
                <div class="px-4 mt-6 mb-2 text-xs font-bold text-slate-400 uppercase tracking-wider">知識管理</div>
                
                <div onclick="navigate('documents', 'all')" class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg cursor-pointer hover:bg-slate-50 text-slate-600 transition-colors">
                    <i data-lucide="file-text" class="w-5 h-5"></i>
                    <span>文件庫總覽</span>
                </div>
                 <div onclick="navigate('documents', '機房維運')" class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg cursor-pointer hover:bg-slate-50 text-slate-600 transition-colors">
                    <i data-lucide="server" class="w-5 h-5"></i>
                    <span>機房維運</span>
                </div>
                 <div onclick="navigate('documents', 'ISMS')" class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg cursor-pointer hover:bg-slate-50 text-slate-600 transition-colors">
                    <i data-lucide="shield-check" class="w-5 h-5"></i>
                    <span>ISMS 資安</span>
                </div>

                <div class="px-4 mt-6 mb-2 text-xs font-bold text-slate-400 uppercase tracking-wider">專案與系統</div>

                <div onclick="navigate('projects')" class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg cursor-pointer hover:bg-slate-50 text-slate-600 transition-colors">
                    <i data-lucide="kanban-square" class="w-5 h-5"></i>
                    <span>專案管理</span>
                </div>
                
                 <div onclick="navigate('database')" class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg cursor-pointer hover:bg-slate-50 text-slate-600 transition-colors">
                    <i data-lucide="database" class="w-5 h-5"></i>
                    <span>資料庫與備份</span>
                </div>
                 <div onclick="navigate('users')" class="nav-item flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg cursor-pointer hover:bg-slate-50 text-slate-600 transition-colors" id="nav-users">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    <span>帳號管理</span>
                </div>
            </nav>

            <div class="p-4 border-t border-slate-100 bg-slate-50/50">
                <div class="flex items-center gap-3 px-2">
                    <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-xs text-slate-600 font-bold border-2 border-white shadow-sm" id="user-avatar">A</div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-bold text-slate-700 truncate" id="user-name">Guest</div>
                        <div class="text-xs text-slate-500 truncate" id="user-role">Not Logged In</div>
                    </div>
                    <button onclick="logout()" class="text-slate-400 hover:text-twm-orange"><i data-lucide="log-out" class="w-4 h-4"></i></button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-full bg-[#F8F9FA] relative overflow-hidden">
            <!-- Top Bar -->
            <header class="h-16 flex items-center px-8 justify-between shrink-0 bg-white/80 backdrop-blur border-b border-slate-200 z-10 sticky top-0">
                <div class="flex items-center gap-2 text-sm text-slate-500 font-medium" id="breadcrumbs">
                    <!-- Breadcrumbs injected by JS -->
                </div>
                <div class="flex items-center gap-4">
                    <div class="relative">
                         <i data-lucide="search" class="w-4 h-4 absolute left-3 top-2.5 text-slate-400"></i>
                         <input type="text" placeholder="搜尋文件..." class="pl-9 pr-4 py-2 bg-slate-100 border-none rounded-full text-sm focus:ring-2 focus:ring-twm-orange focus:bg-white transition-all w-64">
                    </div>
                </div>
            </header>

            <!-- Content Scroll Area -->
            <div id="app-content" class="flex-1 overflow-y-auto overflow-x-hidden p-8">
                <!-- Content Injected Here -->
            </div>
        </main>
    </div>

    <!-- Hidden Input for Database Import -->
    <input type="file" id="excel-upload" accept=".xlsx, .xls" class="hidden" />
    
    <!-- Hidden Input for Quick File Upload -->
    <input type="file" id="quick-file-upload" class="hidden" onchange="handleQuickUpload(this)" />

    <script>
        // --- DATA STORE ---
        const store = {
            docs: [],
            projects: [],
            users: [],
            history: [], // { id, docId, title, content, modifiedBy, modifiedAt }
            currentUser: null,
            view: 'dashboard',
            selectedId: null,
            filterCategory: 'all'
        };

        const MOCK_DOCS = [
            { id: 'd1', title: '機房進出管制規範 v2.0', content: '# 機房進出管制\n\n所有人員進出機房需填寫登記表...\n\n- 需配戴識別證\n- 禁止攜帶飲食', category: '機房維運', tags: ['SOP', 'Security'], attachments: [], updatedAt: new Date().toISOString() },
            { id: 'd2', title: 'ISMS 資訊安全政策公告', content: '## 113年度 ISMS 政策\n\n本公司承諾保護客戶資料...', category: 'ISMS', tags: ['Policy'], attachments: [], updatedAt: new Date().toISOString() },
            { id: 'd3', title: '伺服器例行性維護檢核表', content: '每週一執行：\n1. 檢查硬碟燈號\n2. 確認冷氣溫度(22度)', category: '機房維運', tags: ['Checklist'], attachments: [], updatedAt: new Date().toISOString() }
        ];

        const MOCK_PROJECTS = [
            { 
                id: 'p1', name: '機房空調汰換案', status: 'In Progress', 
                tasks: [
                    { id: 't1', title: '廠商報價單審核', status: 'Done', priority: 'High' },
                    { id: 't2', title: '施工排程確認', status: 'In Progress', priority: 'High' }
                ] 
            }
        ];

        const MOCK_USERS = [
            { id: 'u1', username: 'admin', password: 'admin', name: '系統管理員', role: 'ADMIN' },
            { id: 'u2', username: 'user', password: 'user', name: '一般職員', role: 'USER' }
        ];

        // --- INIT ---
        function init() {
            // Load Data
            const savedDocs = localStorage.getItem('wf_docs');
            const savedProjects = localStorage.getItem('wf_projects');
            const savedUsers = localStorage.getItem('wf_users');
            const savedHistory = localStorage.getItem('wf_history');

            store.docs = savedDocs ? JSON.parse(savedDocs) : MOCK_DOCS;
            store.projects = savedProjects ? JSON.parse(savedProjects) : MOCK_PROJECTS;
            store.users = savedUsers ? JSON.parse(savedUsers) : MOCK_USERS;
            store.history = savedHistory ? JSON.parse(savedHistory) : [];

            // Check Session
            const sessionUser = sessionStorage.getItem('wf_session');
            if (sessionUser) {
                store.currentUser = JSON.parse(sessionUser);
                showApp();
            } else {
                showLogin();
            }
        }

        // --- AUTH ---
        function showLogin() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            // Update Sidebar User Info
            document.getElementById('user-avatar').innerText = store.currentUser.name[0];
            document.getElementById('user-name').innerText = store.currentUser.name;
            document.getElementById('user-role').innerText = store.currentUser.role;

            // Hide/Show Admin Menus
            if (store.currentUser.role !== 'ADMIN') {
                document.getElementById('nav-users').classList.add('hidden');
            } else {
                document.getElementById('nav-users').classList.remove('hidden');
            }

            navigate('dashboard');
        }

        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('login-username').value;
            const p = document.getElementById('login-password').value;
            
            const user = store.users.find(user => user.username === u && user.password === p);
            
            if (user) {
                store.currentUser = user;
                sessionStorage.setItem('wf_session', JSON.stringify(user));
                document.getElementById('login-error').classList.add('hidden');
                showApp();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        function logout() {
            sessionStorage.removeItem('wf_session');
            store.currentUser = null;
            showLogin();
        }

        // --- ROUTING ---
        function navigate(view, param = null) {
            store.view = view;
            
            if (view === 'documents' && typeof param === 'string') {
                store.filterCategory = param;
                store.selectedId = null;
            } else {
                store.selectedId = param;
            }

            render();
        }

        function render() {
            const container = document.getElementById('app-content');
            const breadcrumbs = document.getElementById('breadcrumbs');
            
            // Sidebar State
            document.querySelectorAll('.nav-item').forEach(el => {
                const clickAttr = el.getAttribute('onclick');
                let isActive = false;
                
                if (store.view === 'documents') {
                     if (clickAttr.includes(`'${store.view}', '${store.filterCategory}'`)) isActive = true;
                } else {
                     if (clickAttr.includes(`'${store.view}'`)) isActive = true;
                }

                if (isActive) {
                    el.classList.add('sidebar-active');
                    el.classList.remove('text-slate-600');
                } else {
                    el.classList.remove('sidebar-active');
                    el.classList.add('text-slate-600');
                }
            });

            // Route Logic
            switch(store.view) {
                case 'dashboard':
                    breadcrumbs.innerHTML = '<span>首頁</span> <span class="mx-2">/</span> <span class="text-twm-orange font-bold">儀表板</span>';
                    container.innerHTML = renderDashboard();
                    break;
                case 'documents':
                    const catName = store.filterCategory === 'all' ? '文件庫總覽' : store.filterCategory;
                    breadcrumbs.innerHTML = `<span>文件庫</span> <span class="mx-2">/</span> <span class="text-twm-orange font-bold">${catName}</span>`;
                    container.innerHTML = renderDocList();
                    break;
                case 'doc-edit':
                    const doc = store.docs.find(d => d.id === store.selectedId);
                    breadcrumbs.innerHTML = `<span class="cursor-pointer hover:text-twm-orange" onclick="navigate('documents', 'all')">文件庫</span> <span class="mx-2">/</span> <span>${doc ? '編輯' : '新增文件'}</span>`;
                    container.innerHTML = renderDocEditor(doc);
                    break;
                case 'doc-view':
                    const vDoc = store.docs.find(d => d.id === store.selectedId);
                    breadcrumbs.innerHTML = `<span class="cursor-pointer hover:text-twm-orange" onclick="navigate('documents', 'all')">文件庫</span> <span class="mx-2">/</span> <span>${vDoc?.title || 'Untitled'}</span>`;
                    container.innerHTML = renderDocView(vDoc);
                    break;
                case 'projects':
                    breadcrumbs.innerHTML = '<span>專案管理</span> <span class="mx-2">/</span> <span class="text-twm-orange font-bold">專案列表</span>';
                    container.innerHTML = renderProjectList();
                    break;
                case 'project-board':
                    const proj = store.projects.find(p => p.id === store.selectedId);
                    breadcrumbs.innerHTML = `<span class="cursor-pointer hover:text-twm-orange" onclick="navigate('projects')">專案列表</span> <span class="mx-2">/</span> <span class="text-twm-orange font-bold">${proj?.name}</span>`;
                    container.innerHTML = renderProjectBoard(proj);
                    initDragAndDrop(proj.id);
                    break;
                case 'database':
                    breadcrumbs.innerHTML = '<span>系統管理</span> <span class="mx-2">/</span> <span class="text-twm-orange font-bold">資料庫管理</span>';
                    container.innerHTML = renderDatabaseManager();
                    break;
                case 'users':
                    breadcrumbs.innerHTML = '<span>系統管理</span> <span class="mx-2">/</span> <span class="text-twm-orange font-bold">帳號管理</span>';
                    container.innerHTML = renderUserManager();
                    break;
                default:
                    container.innerHTML = '<div class="p-8">404 Not Found</div>';
            }
            
            lucide.createIcons();
        }

        // --- VIEWS ---

        function renderDashboard() {
            return `
                <div class="max-w-6xl mx-auto space-y-8" id="dashboard-content">
                    <div class="flex justify-between items-end">
                        <div>
                            <h1 class="text-3xl font-bold text-slate-800">早安，${store.currentUser.name}</h1>
                            <p class="text-slate-500 mt-1">Life is for connecting. 今天的系統概況如下：</p>
                        </div>
                        <button onclick="downloadChart()" class="text-sm text-slate-400 hover:text-twm-orange flex items-center gap-1">
                            <i data-lucide="camera" class="w-4 h-4"></i> 匯出報表
                        </button>
                    </div>

                    <!-- Security Banner -->
                    <div class="bg-orange-50 border-l-4 border-twm-orange p-4 rounded-r shadow-sm flex items-start gap-3">
                        <i data-lucide="shield-alert" class="w-6 h-6 text-twm-orange shrink-0 mt-0.5"></i>
                        <div>
                            <h3 class="font-bold text-twm-orange text-sm">資安與儲存宣告 (Local Storage Only)</h3>
                            <p class="text-sm text-slate-600 mt-1">
                                本系統運作於「本機離線模式」。您上傳的機房維運、ISMS 表單及各類文件檔案，**僅儲存於您目前的電腦硬碟 C 槽 (瀏覽器快取)**。
                                本介面僅提供檔名索引與統計數據展示，不會將實體檔案上傳至任何雲端伺服器。請務必定期至「資料庫管理」執行 Excel 匯出備份。
                            </p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all border-t-4 border-t-twm-orange cursor-pointer" onclick="navigate('documents', 'all')">
                            <div class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">文件總數</div>
                            <div class="text-4xl font-bold text-slate-800">${store.docs.length}</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all border-t-4 border-t-blue-500 cursor-pointer" onclick="navigate('documents', '機房維運')">
                            <div class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">機房維運文件</div>
                            <div class="text-4xl font-bold text-slate-800">${store.docs.filter(d => d.category === '機房維運').length}</div>
                        </div>
                         <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all border-t-4 border-t-purple-500 cursor-pointer" onclick="navigate('documents', 'ISMS')">
                            <div class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">ISMS 資安文件</div>
                            <div class="text-4xl font-bold text-slate-800">${store.docs.filter(d => d.category === 'ISMS').length}</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all border-t-4 border-t-green-500 cursor-pointer" onclick="navigate('projects')">
                            <div class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">進行中專案</div>
                            <div class="text-4xl font-bold text-slate-800">${store.projects.length}</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                            <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-slate-700">
                                <i data-lucide="clock" class="w-5 h-5 text-twm-orange"></i> 最近更新文件
                            </h2>
                            <div class="space-y-3">
                                ${store.docs.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt)).slice(0, 5).map(doc => `
                                    <div onclick="navigate('doc-view', '${doc.id}')" class="flex items-center justify-between p-3 rounded-lg hover:bg-slate-50 cursor-pointer group border border-transparent hover:border-slate-100 transition-all">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 rounded bg-slate-100 flex items-center justify-center text-slate-400 group-hover:bg-orange-100 group-hover:text-twm-orange transition-colors">
                                                <i data-lucide="file" class="w-4 h-4"></i>
                                            </div>
                                            <div>
                                                <div class="font-bold text-sm text-slate-700 group-hover:text-twm-orange">${doc.title}</div>
                                                <div class="text-xs text-slate-400">${doc.category}</div>
                                            </div>
                                        </div>
                                        <span class="text-xs text-slate-400">${new Date(doc.updatedAt).toLocaleDateString()}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                         <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                            <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-slate-700">
                                <i data-lucide="zap" class="w-5 h-5 text-twm-orange"></i> 快速存取 (本機上傳)
                            </h2>
                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="triggerQuickUpload('機房維運')" class="p-4 border border-dashed border-slate-300 rounded-lg hover:border-twm-orange hover:bg-orange-50 transition-all flex flex-col items-center justify-center gap-2 group">
                                    <i data-lucide="upload-cloud" class="w-6 h-6 text-slate-400 group-hover:text-twm-orange"></i>
                                    <span class="text-sm font-medium text-slate-600 group-hover:text-twm-orange">上傳維運日誌</span>
                                </button>
                                 <button onclick="triggerQuickUpload('ISMS')" class="p-4 border border-dashed border-slate-300 rounded-lg hover:border-twm-orange hover:bg-orange-50 transition-all flex flex-col items-center justify-center gap-2 group">
                                    <i data-lucide="shield" class="w-6 h-6 text-slate-400 group-hover:text-twm-orange"></i>
                                    <span class="text-sm font-medium text-slate-600 group-hover:text-twm-orange">上傳 ISMS 表單</span>
                                </button>
                            </div>
                            <p class="text-[10px] text-slate-400 mt-4 text-center">所有上傳動作僅將檔案編碼存入本機緩存 (C 槽)，請安心使用。</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDocList() {
            const filteredDocs = store.filterCategory === 'all' 
                ? store.docs 
                : store.docs.filter(d => d.category === store.filterCategory);

            return `
                <div class="max-w-6xl mx-auto">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                        <div>
                            <h1 class="text-3xl font-bold text-slate-800">${store.filterCategory === 'all' ? '文件庫' : store.filterCategory}</h1>
                            <p class="text-slate-500 text-sm mt-1">共 ${filteredDocs.length} 份文件 (Local Database)</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="triggerQuickUpload('${store.filterCategory}')" class="bg-white border border-slate-300 hover:border-twm-orange hover:text-twm-orange text-slate-700 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-sm transition-all">
                                <i data-lucide="upload" class="w-4 h-4"></i> 上傳檔案
                            </button>
                            <button onclick="navigate('doc-edit')" class="btn-primary px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-lg shadow-orange-200">
                                <i data-lucide="plus" class="w-4 h-4"></i> 新增文件
                            </button>
                        </div>
                    </div>

                    <!-- Category Tabs -->
                    <div class="flex gap-1 mb-6 border-b border-slate-200 overflow-x-auto">
                        <button onclick="navigate('documents', 'all')" class="px-4 py-2 text-sm font-medium border-b-2 transition-colors whitespace-nowrap ${store.filterCategory === 'all' ? 'border-twm-orange text-twm-orange' : 'border-transparent text-slate-500 hover:text-slate-700'}">全部文件</button>
                        <button onclick="navigate('documents', '機房維運')" class="px-4 py-2 text-sm font-medium border-b-2 transition-colors whitespace-nowrap ${store.filterCategory === '機房維運' ? 'border-twm-orange text-twm-orange' : 'border-transparent text-slate-500 hover:text-slate-700'}">機房維運</button>
                        <button onclick="navigate('documents', 'ISMS')" class="px-4 py-2 text-sm font-medium border-b-2 transition-colors whitespace-nowrap ${store.filterCategory === 'ISMS' ? 'border-twm-orange text-twm-orange' : 'border-transparent text-slate-500 hover:text-slate-700'}">ISMS 資安</button>
                         <button onclick="navigate('documents', 'General')" class="px-4 py-2 text-sm font-medium border-b-2 transition-colors whitespace-nowrap ${store.filterCategory === 'General' ? 'border-twm-orange text-twm-orange' : 'border-transparent text-slate-500 hover:text-slate-700'}">一般行政</button>
                    </div>
                    
                    ${filteredDocs.length === 0 ? 
                        `<div class="text-center py-20 bg-white rounded-xl border border-slate-200 border-dashed">
                            <div class="inline-flex p-4 bg-slate-50 rounded-full mb-4"><i data-lucide="folder-open" class="w-8 h-8 text-slate-400"></i></div>
                            <p class="text-slate-500">此分類尚無文件</p>
                            <button onclick="triggerQuickUpload('${store.filterCategory}')" class="text-twm-orange hover:underline text-sm font-bold mt-2">立即上傳至本機硬碟</button>
                        </div>` 
                    : 
                        `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${filteredDocs.map(doc => `
                                <div onclick="navigate('doc-view', '${doc.id}')" class="group bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all cursor-pointer flex flex-col h-48">
                                    <div class="flex justify-between items-start mb-3">
                                        <span class="bg-orange-50 text-twm-orange px-2 py-1 rounded text-[10px] font-bold tracking-wide uppercase">${doc.category}</span>
                                        ${doc.attachments.length > 0 ? '<i data-lucide="paperclip" class="w-3 h-3 text-slate-400"></i>' : ''}
                                    </div>
                                    <h3 class="font-bold text-lg text-slate-800 mb-2 line-clamp-2 group-hover:text-twm-orange transition-colors">${doc.title}</h3>
                                    <p class="text-sm text-slate-400 line-clamp-3 mt-auto">${doc.content.replace(/[#*]/g, '') || '無內容預覽'}</p>
                                </div>
                            `).join('')}
                        </div>`
                    }
                </div>
            `;
        }

        function renderDocView(doc) {
            if (!doc) return '<div>Doc not found</div>';
            const htmlContent = marked.parse(doc.content);
            const historyCount = store.history.filter(h => h.docId === doc.id).length;

            return `
                <div class="flex gap-6 h-full">
                    <div class="flex-1 overflow-y-auto">
                        <div class="max-w-4xl mx-auto bg-white p-10 rounded-xl shadow-sm border border-slate-200 min-h-[80vh]">
                            <div class="mb-8 border-b border-slate-100 pb-6">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex items-center gap-2 text-sm">
                                        <span class="px-2.5 py-0.5 bg-twm-orange text-white rounded text-xs font-bold">${doc.category}</span>
                                        <span class="text-slate-400">•</span>
                                        <span class="text-slate-400">Updated ${new Date(doc.updatedAt).toLocaleString()} by ${doc.updatedBy || 'Unknown'}</span>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="toggleHistoryPanel()" class="text-sm text-slate-500 hover:text-twm-orange flex items-center gap-1 px-3 py-1 rounded hover:bg-orange-50 transition-colors">
                                            <i data-lucide="history" class="w-4 h-4"></i> 版本 (${historyCount})
                                        </button>
                                        <button onclick="navigate('doc-edit', '${doc.id}')" class="text-sm text-slate-500 hover:text-twm-orange flex items-center gap-1 px-3 py-1 rounded hover:bg-orange-50 transition-colors">
                                            <i data-lucide="edit-3" class="w-4 h-4"></i> 編輯
                                        </button>
                                    </div>
                                </div>
                                <h1 class="text-4xl font-bold text-slate-900 leading-tight">${doc.title}</h1>
                            </div>
                            
                            <article class="prose prose-slate max-w-none prose-headings:font-bold prose-a:text-twm-orange">
                                ${htmlContent}
                            </article>

                            ${doc.attachments && doc.attachments.length > 0 ? `
                                <div class="mt-12 pt-6 border-t border-slate-200">
                                    <h3 class="text-sm font-bold text-slate-500 uppercase mb-4 flex items-center gap-2">
                                        <i data-lucide="folder-down" class="w-4 h-4"></i> 附件下載區 (Local)
                                    </h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        ${doc.attachments.map(att => `
                                            <div class="flex items-center justify-between p-4 border border-slate-200 rounded-lg hover:border-twm-orange hover:bg-orange-50 transition-all group bg-slate-50">
                                                <div class="flex items-center gap-3 overflow-hidden">
                                                    <div class="bg-white p-2 rounded shadow-sm text-twm-orange">
                                                        <i data-lucide="file" class="w-5 h-5"></i>
                                                    </div>
                                                    <div>
                                                        <div class="truncate text-sm font-bold text-slate-700 group-hover:text-twm-orange">${att.name}</div>
                                                        <div class="text-xs text-slate-400">${Math.round(att.size/1024)} KB</div>
                                                    </div>
                                                </div>
                                                <a href="${att.data}" download="${att.name}" class="text-slate-400 hover:text-twm-orange p-2 rounded-full hover:bg-white transition-colors">
                                                    <i data-lucide="download" class="w-5 h-5"></i>
                                                </a>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- History Panel (Hidden by default) -->
                    <div id="history-panel" class="w-80 bg-white border-l border-slate-200 p-6 hidden flex-col shadow-lg">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-lg text-slate-800">版本紀錄</h3>
                            <button onclick="toggleHistoryPanel()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <div class="flex-1 overflow-y-auto space-y-4">
                            ${store.history.filter(h => h.docId === doc.id).sort((a,b) => new Date(b.modifiedAt) - new Date(a.modifiedAt)).map(h => `
                                <div class="p-3 rounded-lg border border-slate-100 bg-slate-50 hover:border-twm-orange cursor-pointer" onclick="alert('預覽功能：\\n' + '${h.title}')">
                                    <div class="text-xs text-slate-400 mb-1">${new Date(h.modifiedAt).toLocaleString()}</div>
                                    <div class="text-sm font-bold text-slate-700 mb-1">修訂者: ${h.modifiedBy}</div>
                                    <button onclick="restoreVersion('${h.id}')" class="text-xs text-twm-orange hover:underline">還原此版本</button>
                                </div>
                            `).join('')}
                            ${historyCount === 0 ? '<div class="text-sm text-slate-400 text-center">尚無修訂紀錄</div>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function toggleHistoryPanel() {
            const panel = document.getElementById('history-panel');
            panel.classList.toggle('hidden');
            panel.classList.toggle('flex');
        }

        function restoreVersion(historyId) {
            if(!confirm('確定要還原至此版本嗎？目前內容將會被覆蓋並存為新版本。')) return;
            const historyItem = store.history.find(h => h.id === historyId);
            if(historyItem) {
                const docIdx = store.docs.findIndex(d => d.id === historyItem.docId);
                // Save current as history before restore
                const currentDoc = store.docs[docIdx];
                 store.history.push({
                    id: 'h' + Date.now(),
                    docId: currentDoc.id,
                    title: currentDoc.title,
                    content: currentDoc.content,
                    modifiedBy: store.currentUser.name,
                    modifiedAt: new Date().toISOString()
                });

                // Restore
                store.docs[docIdx] = {
                    ...store.docs[docIdx],
                    title: historyItem.title,
                    content: historyItem.content,
                    updatedAt: new Date().toISOString(),
                    updatedBy: store.currentUser.name
                };
                saveToStorage();
                render(); // Re-render to update view
            }
        }

        function renderDocEditor(doc) {
            const isNew = !doc;
            const data = doc || { title: '', content: '', category: store.filterCategory === 'all' ? 'General' : store.filterCategory, tags: [], attachments: [] };
            
            // Temporary Edit State
            window.currentEditDoc = JSON.parse(JSON.stringify(data)); 

            return `
                <div class="max-w-4xl mx-auto bg-white p-10 rounded-xl shadow-sm border border-slate-200 h-full flex flex-col">
                    <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100">
                        <h2 class="text-xl font-bold text-slate-400 flex items-center gap-2">
                             ${isNew ? '<i data-lucide="file-plus" class="w-5 h-5"></i> 新增文件' : '<i data-lucide="edit" class="w-5 h-5"></i> 編輯文件'}
                        </h2>
                        <div class="flex gap-3">
                            <button onclick="navigate('${isNew ? 'documents' : 'doc-view'}', '${isNew ? store.filterCategory : doc.id}')" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg font-medium transition-colors">取消</button>
                            <button onclick="saveDoc('${isNew ? '' : doc.id}')" class="btn-primary px-6 py-2 rounded-lg font-bold shadow-lg shadow-orange-200">儲存文件</button>
                        </div>
                    </div>

                    <input type="text" id="edit-title" value="${data.title}" placeholder="請輸入文件標題..." class="text-3xl font-bold border-none focus:ring-0 px-0 placeholder-slate-300 w-full mb-6 text-slate-800">
                    
                    <div class="grid grid-cols-2 gap-6 mb-8">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wide mb-1">分類 Category</label>
                            <select id="edit-category" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-700 font-medium focus:ring-2 focus:ring-twm-orange focus:border-transparent outline-none">
                                <option value="General" ${data.category === 'General' ? 'selected' : ''}>General 一般行政</option>
                                <option value="機房維運" ${data.category === '機房維運' ? 'selected' : ''}>機房維運</option>
                                <option value="ISMS" ${data.category === 'ISMS' ? 'selected' : ''}>ISMS 資安管理</option>
                                <option value="HR" ${data.category === 'HR' ? 'selected' : ''}>HR 人資規章</option>
                            </select>
                        </div>
                        <div>
                             <label class="block text-xs font-bold text-slate-400 uppercase tracking-wide mb-1">附件 Attachment</label>
                             <button onclick="document.getElementById('file-upload-input').click()" class="w-full text-left px-3 py-2 bg-slate-50 border border-slate-200 border-dashed rounded-lg text-slate-500 hover:text-twm-orange hover:border-twm-orange hover:bg-orange-50 transition-all text-sm flex items-center gap-2">
                                <i data-lucide="upload" class="w-4 h-4"></i> 點擊上傳檔案 (Local Only)
                             </button>
                             <input type="file" id="file-upload-input" class="hidden" onchange="handleFileUpload(this)">
                             <p class="text-[10px] text-red-500 font-bold mt-1">注意：檔案僅儲存於個人電腦 C 槽，請勿上傳機密個資。</p>
                        </div>
                    </div>

                    <textarea id="edit-content" class="flex-1 w-full resize-none border-none focus:ring-0 p-4 bg-slate-50 rounded-lg text-base leading-relaxed text-slate-700 placeholder-slate-400 outline-none mb-6" placeholder="在此輸入內容 (支援 Markdown)...">${data.content}</textarea>

                    <div id="attachments-list" class="space-y-2">
                        ${renderAttachmentsList(data.attachments)}
                    </div>
                </div>
            `;
        }

        function renderAttachmentsList(attachments) {
            if (!attachments || attachments.length === 0) return '';
            return attachments.map((att, idx) => `
                <div class="flex items-center justify-between bg-slate-50 p-3 rounded-lg border border-slate-200">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="bg-white p-1.5 rounded text-twm-orange shadow-sm"><i data-lucide="file" class="w-4 h-4"></i></div>
                        <span class="text-sm font-medium text-slate-700 truncate">${att.name}</span>
                        <span class="text-xs text-slate-400">(${Math.round(att.size/1024)} KB)</span>
                    </div>
                    <button onclick="removeAttachment(${idx})" class="p-1 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-colors">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `).join('');
        }

        // --- ATTACHMENT LOGIC ---
        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            processFile(file, (att) => {
                window.currentEditDoc.attachments.push(att);
                document.getElementById('attachments-list').innerHTML = renderAttachmentsList(window.currentEditDoc.attachments);
                lucide.createIcons();
            });
        }

        // Quick Upload logic for the button in Document List
        function triggerQuickUpload(category) {
            store.filterCategory = category === 'all' ? 'General' : category; // Set context
            document.getElementById('quick-file-upload').click();
        }

        function handleQuickUpload(input) {
            const file = input.files[0];
            if (!file) return;

            processFile(file, (att) => {
                // Auto-create document
                const newDoc = {
                    id: 'd' + Date.now(),
                    title: file.name,
                    content: `檔案已上傳：${file.name}\n\n此文件由快速上傳功能自動建立。檔案儲存於本機 Local Storage。`,
                    category: store.filterCategory,
                    tags: ['Upload'],
                    attachments: [att],
                    updatedAt: new Date().toISOString(),
                    updatedBy: store.currentUser.name
                };
                store.docs.unshift(newDoc);
                saveToStorage();
                navigate('doc-view', newDoc.id); // Go to view
            });
            input.value = ''; // Reset
        }

        function processFile(file, callback) {
            if (file.size > 2 * 1024 * 1024) { alert("檔案過大，請小於 2MB (LocalStorage 限制)"); return; }
            const reader = new FileReader();
            reader.onload = function(e) {
                callback({
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    data: e.target.result,
                    uploadedAt: new Date().toISOString()
                });
            };
            reader.readAsDataURL(file);
        }

        function removeAttachment(index) {
            window.currentEditDoc.attachments.splice(index, 1);
            document.getElementById('attachments-list').innerHTML = renderAttachmentsList(window.currentEditDoc.attachments);
            lucide.createIcons();
        }

        function saveDoc(id) {
            const title = document.getElementById('edit-title').value;
            const content = document.getElementById('edit-content').value;
            const category = document.getElementById('edit-category').value;

            if (!title) return alert('請輸入標題');

            // --- VERSION CONTROL: Save History if editing existing doc ---
            if (id) {
                const oldDoc = store.docs.find(d => d.id === id);
                if (oldDoc) {
                    store.history.push({
                        id: 'h' + Date.now(),
                        docId: oldDoc.id,
                        title: oldDoc.title,
                        content: oldDoc.content,
                        modifiedBy: store.currentUser.name,
                        modifiedAt: new Date().toISOString()
                    });
                }
            }

            const docData = {
                ...window.currentEditDoc,
                id: id || 'd' + Date.now(),
                title,
                content,
                category,
                updatedAt: new Date().toISOString(),
                updatedBy: store.currentUser.name
            };

            if (id) {
                const idx = store.docs.findIndex(d => d.id === id);
                store.docs[idx] = docData;
            } else {
                store.docs.unshift(docData);
            }
            
            saveToStorage();
            navigate('doc-view', docData.id);
        }

        // --- CHART DOWNLOAD ---
        function downloadChart() {
            const element = document.getElementById('dashboard-content');
            html2canvas(element).then(canvas => {
                const link = document.createElement('a');
                link.download = `report_${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        // --- PROJECT VIEWS ---
        function renderProjectList() {
            return `
                <div class="max-w-6xl mx-auto">
                     <div class="flex justify-between items-center mb-8">
                        <h1 class="text-3xl font-bold text-slate-800">專案看板</h1>
                        <button onclick="createProject()" class="btn-primary px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-lg shadow-orange-200">
                            <i data-lucide="plus" class="w-4 h-4"></i> 新增專案
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${store.projects.map(p => `
                            <div onclick="navigate('project-board', '${p.id}')" class="group bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-lg transition-all cursor-pointer relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-2 h-full ${p.status === 'Active' ? 'bg-twm-orange' : 'bg-slate-300'}"></div>
                                <div class="pl-4">
                                    <div class="flex justify-between items-start mb-4">
                                        <h3 class="font-bold text-xl text-slate-800 group-hover:text-twm-orange transition-colors">${p.name}</h3>
                                        <span class="px-2 py-1 bg-slate-100 rounded text-xs font-bold text-slate-500">${p.status}</span>
                                    </div>
                                    <div class="flex items-center gap-6 text-sm text-slate-500">
                                        <div class="flex items-center gap-1"><i data-lucide="list-todo" class="w-4 h-4"></i> ${p.tasks.length} 任務</div>
                                        <div class="flex items-center gap-1"><i data-lucide="check-circle-2" class="w-4 h-4 text-green-500"></i> ${p.tasks.filter(t => t.status === 'Done').length} 完成</div>
                                    </div>
                                    <div class="mt-4 w-full bg-slate-100 rounded-full h-1.5">
                                        <div class="bg-twm-orange h-1.5 rounded-full" style="width: ${p.tasks.length ? (p.tasks.filter(t => t.status === 'Done').length / p.tasks.length) * 100 : 0}%"></div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function createProject() {
            const name = prompt("請輸入專案名稱：");
            if(name) {
                const newProj = {
                    id: 'p' + Date.now(),
                    name: name,
                    status: 'Active',
                    tasks: []
                };
                store.projects.push(newProj);
                saveToStorage();
                navigate('project-board', newProj.id);
            }
        }

        function renderProjectBoard(project) {
            if(!project) return 'Project not found';
            const statuses = ['To Do', 'In Progress', 'Done'];
            
            return `
                <div class="flex flex-col h-full overflow-hidden">
                    <div class="h-16 flex items-center justify-between shrink-0 mb-4">
                        <div class="flex items-center gap-4">
                            <h2 class="font-bold text-2xl text-slate-800">${project.name}</h2>
                            <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">Active</span>
                        </div>
                        <button onclick="addTask('${project.id}')" class="btn-primary px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-sm">
                             <i data-lucide="plus" class="w-4 h-4"></i> 新增任務
                        </button>
                    </div>
                    
                    <div class="flex-1 overflow-x-auto overflow-y-hidden pb-4">
                        <div class="flex h-full gap-6 w-max">
                            ${statuses.map(status => `
                                <div class="w-80 flex flex-col bg-slate-100 rounded-xl p-4 border border-slate-200" ondrop="drop(event, '${status}')" ondragover="allowDrop(event)">
                                    <div class="flex justify-between items-center mb-4 px-1">
                                        <span class="text-sm font-bold text-slate-600 uppercase tracking-wide flex items-center gap-2">
                                            <span class="w-2 h-2 rounded-full ${status === 'Done' ? 'bg-green-500' : (status === 'In Progress' ? 'bg-twm-orange' : 'bg-slate-400')}"></span>
                                            ${status}
                                        </span>
                                        <span class="text-xs bg-white px-2 py-0.5 rounded-full text-slate-500 font-bold border border-slate-200 shadow-sm">${project.tasks.filter(t => t.status === status).length}</span>
                                    </div>
                                    <div class="flex-1 overflow-y-auto kanban-col space-y-3 pr-1">
                                        ${project.tasks.filter(t => t.status === status).map(task => `
                                            <div id="${task.id}" draggable="true" ondragstart="drag(event)" class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 cursor-move hover:shadow-md hover:border-twm-orange transition-all group relative">
                                                <div class="flex justify-between items-start mb-2">
                                                    <span class="text-[10px] px-2 py-0.5 rounded font-bold ${task.priority === 'High' ? 'bg-red-50 text-red-600' : 'bg-slate-50 text-slate-500'}">${task.priority}</span>
                                                    <button onclick="deleteTask('${project.id}', '${task.id}')" class="text-slate-300 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                                </div>
                                                <div class="text-sm font-bold text-slate-800 leading-snug">${task.title}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- KANBAN LOGIC ---
        function allowDrop(ev) { ev.preventDefault(); }
        function drag(ev) { ev.dataTransfer.setData("text", ev.target.id); }
        function drop(ev, newStatus) {
            ev.preventDefault();
            const taskId = ev.dataTransfer.getData("text");
            const proj = store.projects.find(p => p.id === store.selectedId);
            const task = proj.tasks.find(t => t.id === taskId);
            if (task) {
                task.status = newStatus;
                saveToStorage();
                render(); 
            }
        }
        function addTask(pid) {
            const title = prompt("任務標題:");
            if (title) {
                const proj = store.projects.find(p => p.id === pid);
                proj.tasks.push({ id: 't'+Date.now(), title, status: 'To Do', priority: 'Medium' });
                saveToStorage();
                render();
            }
        }
        function deleteTask(pid, tid) {
            if(!confirm("刪除此任務?")) return;
            const proj = store.projects.find(p => p.id === pid);
            proj.tasks = proj.tasks.filter(t => t.id !== tid);
            saveToStorage();
            render();
        }

        // --- USER MANAGER ---
        function renderUserManager() {
             return `
                <div class="max-w-4xl mx-auto">
                    <div class="flex justify-between items-center mb-8">
                        <h1 class="text-3xl font-bold text-slate-800">帳號管理</h1>
                        <button onclick="addUser()" class="btn-primary px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-lg shadow-orange-200">
                            <i data-lucide="user-plus" class="w-4 h-4"></i> 新增使用者
                        </button>
                    </div>

                    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                        <table class="w-full text-sm text-left text-slate-600">
                            <thead class="text-xs text-slate-400 uppercase bg-slate-50 border-b border-slate-100">
                                <tr>
                                    <th class="px-6 py-4">姓名</th>
                                    <th class="px-6 py-4">帳號</th>
                                    <th class="px-6 py-4">密碼</th>
                                    <th class="px-6 py-4">角色</th>
                                    <th class="px-6 py-4">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${store.users.map(u => `
                                    <tr class="border-b border-slate-50 hover:bg-slate-50 transition-colors">
                                        <td class="px-6 py-4 font-bold text-slate-800">${u.name}</td>
                                        <td class="px-6 py-4">${u.username}</td>
                                        <td class="px-6 py-4 font-mono text-xs">******</td>
                                        <td class="px-6 py-4">
                                            <span class="px-2 py-1 rounded text-xs font-bold ${u.role === 'ADMIN' ? 'bg-orange-100 text-twm-orange' : 'bg-slate-100 text-slate-500'}">${u.role}</span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="flex items-center gap-3">
                                                <button onclick="editUser('${u.id}')" class="text-twm-blue hover:text-blue-700 font-bold text-xs flex items-center gap-1">
                                                    <i data-lucide="edit" class="w-3 h-3"></i> 修改
                                                </button>
                                                ${u.username !== 'admin' ? 
                                                `<button onclick="deleteUser('${u.id}')" class="text-red-400 hover:text-red-600 font-bold text-xs flex items-center gap-1">
                                                    <i data-lucide="trash" class="w-3 h-3"></i> 刪除
                                                </button>` : 
                                                '<span class="text-slate-300 text-xs italic">系統保護(限刪除)</span>'}
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function addUser() {
            const name = prompt("輸入姓名:");
            const username = prompt("輸入帳號:");
            const password = prompt("輸入密碼:");
            const role = prompt("輸入角色 (ADMIN / USER):", "USER");
            
            if(name && username && password) {
                store.users.push({
                    id: 'u' + Date.now(),
                    name, username, password, role: role.toUpperCase()
                });
                saveToStorage();
                render();
            }
        }
        
        function editUser(uid) {
            const user = store.users.find(u => u.id === uid);
            if(!user) return;
            
            // Name
            const newName = prompt(`修改 ${user.username} 的姓名:`, user.name);
            if (newName !== null && newName.trim() !== "") user.name = newName;

            // Password
            const newPass = prompt(`修改 ${user.username} 的密碼 (若不修改請留空):`);
            if (newPass !== null && newPass.trim() !== "") user.password = newPass;

            // Role (Prevent changing admin role to user via simple prompt to avoid lock-out, or allow it)
            // For simplicity and safety, we allow changing roles for non-admin accounts.
            if (user.username !== 'admin') {
                const newRole = prompt(`修改 ${user.username} 的角色 (ADMIN / USER):`, user.role);
                if (newRole !== null && newRole.trim() !== "") user.role = newRole.toUpperCase();
            }

            saveToStorage();
            render();
            alert("使用者資料更新成功！");
        }

        function deleteUser(uid) {
            if(!confirm("確定刪除此使用者?")) return;
            store.users = store.users.filter(u => u.id !== uid);
            saveToStorage();
            render();
        }

        // --- EXCEL DATABASE MANAGER ---
        function renderDatabaseManager() {
            return `
                 <div class="max-w-4xl mx-auto">
                    <h1 class="text-3xl font-bold mb-8 text-slate-800">資料庫與備份</h1>
                    
                    <!-- SOP Guide -->
                    <div class="bg-white rounded-xl border border-slate-200 p-8 shadow-sm mb-8">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                             <i data-lucide="book-open" class="w-5 h-5 text-twm-orange"></i> 資料維運標準作業程序 (SOP)
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="p-4 bg-slate-50 rounded-lg border border-slate-100">
                                <div class="text-xs font-bold text-slate-400 uppercase mb-2">Step 1</div>
                                <div class="font-bold text-slate-800 mb-1">系統啟動</div>
                                <p class="text-xs text-slate-500">開啟瀏覽器，系統自動讀取上次快取資料 (C槽 Local Cache)。</p>
                            </div>
                             <div class="p-4 bg-slate-50 rounded-lg border border-slate-100">
                                <div class="text-xs font-bold text-slate-400 uppercase mb-2">Step 2</div>
                                <div class="font-bold text-slate-800 mb-1">資料操作</div>
                                <p class="text-xs text-slate-500">上傳文件、管理專案。所有檔案僅存於您的電腦硬碟中。</p>
                            </div>
                             <div class="p-4 bg-orange-50 rounded-lg border border-twm-orange/30">
                                <div class="text-xs font-bold text-twm-orange uppercase mb-2">Step 3 (重要)</div>
                                <div class="font-bold text-slate-800 mb-1">匯出備份</div>
                                <p class="text-xs text-slate-600">操作完畢後，務必點擊下方 <span class="font-bold">匯出資料</span> 儲存 Excel 檔至硬碟。</p>
                            </div>
                             <div class="p-4 bg-slate-50 rounded-lg border border-slate-100">
                                <div class="text-xs font-bold text-slate-400 uppercase mb-2">Step 4</div>
                                <div class="font-bold text-slate-800 mb-1">移轉/還原</div>
                                <p class="text-xs text-slate-500">若更換電腦，請使用 <span class="font-bold">匯入資料</span> 載入先前的 Excel 檔。</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl border border-slate-200 p-8 shadow-sm">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                                    <i data-lucide="file-spreadsheet" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg text-slate-800">匯入資料 (Restore)</h3>
                                    <p class="text-sm text-slate-500">從硬碟選取 Excel (.xlsx) 載入資料以還原系統。</p>
                                </div>
                            </div>
                            <button onclick="document.getElementById('excel-upload').click()" class="w-full bg-slate-50 border border-slate-300 hover:bg-slate-100 text-slate-700 px-4 py-3 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-colors">
                                <i data-lucide="upload" class="w-4 h-4"></i> 選擇本機 Excel 檔案
                            </button>
                        </div>

                        <div class="bg-white rounded-xl border border-slate-200 p-8 shadow-sm">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
                                    <i data-lucide="download-cloud" class="w-6 h-6"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg text-slate-800">匯出資料 (Backup)</h3>
                                    <p class="text-sm text-slate-500">將所有文件、附件與紀錄打包為 Excel 存至硬碟。</p>
                                </div>
                            </div>
                            <button onclick="exportToExcel()" class="w-full btn-primary px-4 py-3 rounded-lg text-sm font-bold flex items-center justify-center gap-2 shadow-lg shadow-orange-200">
                                <i data-lucide="download" class="w-4 h-4"></i> 下載完整備份 (.xlsx)
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- EXCEL LOGIC ---
        document.getElementById('excel-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                if (workbook.Sheets['Docs']) {
                    const rawDocs = XLSX.utils.sheet_to_json(workbook.Sheets['Docs']);
                    store.docs = rawDocs.map(d => ({
                        ...d,
                        tags: d.tags ? JSON.parse(d.tags) : [],
                        attachments: d.attachments ? JSON.parse(d.attachments) : []
                    }));
                }

                if (workbook.Sheets['Projects']) {
                    const rawProjects = XLSX.utils.sheet_to_json(workbook.Sheets['Projects']);
                    store.projects = rawProjects.map(p => ({
                        ...p,
                        tasks: p.tasks ? JSON.parse(p.tasks) : []
                    }));
                }
                
                if (workbook.Sheets['Users']) {
                    store.users = XLSX.utils.sheet_to_json(workbook.Sheets['Users']);
                }
                
                if (workbook.Sheets['History']) {
                    store.history = XLSX.utils.sheet_to_json(workbook.Sheets['History']);
                }

                saveToStorage();
                alert('資料庫匯入成功！請重新登入。');
                logout();
            };
            reader.readAsArrayBuffer(file);
        });

        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            // 1. Docs
            const serializedDocs = store.docs.map(d => ({
                ...d,
                tags: JSON.stringify(d.tags),
                attachments: JSON.stringify(d.attachments)
            }));
            const wsDocs = XLSX.utils.json_to_sheet(serializedDocs);
            XLSX.utils.book_append_sheet(wb, wsDocs, "Docs");

            // 2. Projects
            const serializedProjects = store.projects.map(p => ({
                ...p,
                tasks: JSON.stringify(p.tasks)
            }));
            const wsProjects = XLSX.utils.json_to_sheet(serializedProjects);
            XLSX.utils.book_append_sheet(wb, wsProjects, "Projects");
            
            // 3. Users
            const wsUsers = XLSX.utils.json_to_sheet(store.users);
            XLSX.utils.book_append_sheet(wb, wsUsers, "Users");
            
            // 4. History
            const wsHistory = XLSX.utils.json_to_sheet(store.history);
            XLSX.utils.book_append_sheet(wb, wsHistory, "History");

            XLSX.writeFile(wb, `CDC_Backup_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        function saveToStorage() {
            localStorage.setItem('wf_docs', JSON.stringify(store.docs));
            localStorage.setItem('wf_projects', JSON.stringify(store.projects));
            localStorage.setItem('wf_users', JSON.stringify(store.users));
            localStorage.setItem('wf_history', JSON.stringify(store.history));
        }

        // Start
        init();
    </script>
</body>
</html>
